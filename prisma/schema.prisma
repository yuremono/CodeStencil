// CodeStencil Database Schema
// PostgreSQL + pgvector for vector similarity search

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  templates     Template[]
  codePatterns  CodePattern[]
  apiKeys       ApiKey[]

  @@index([email])
  @@map("users")
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  key         String   @unique
  name        String
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("api_keys")
}

// ============================================================================
// Templates
// ============================================================================

model Template {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  language    String
  tags        String[] // e.g., ["react", "hook", "typescript"]
  isPublic    Boolean  @default(false)
  isSystem    Boolean  @default(false) // System-provided templates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  files        TemplateFile[]
  placeholders Placeholder[]

  @@index([userId])
  @@index([language])
  @@index([isPublic])
  @@map("templates")
}

model TemplateFile {
  id         String   @id @default(cuid())
  templateId String
  path       String   // File path relative to project root
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([templateId, path])
  @@index([templateId])
  @@map("template_files")
}

model Placeholder {
  id         String   @id @default(cuid())
  templateId String
  name       String   // e.g., "componentName", "hookName"
  type       String   // e.g., "string", "boolean", "select"
  default    String?
  required   Boolean  @default(true)
  options    String[] // For select type: ["option1", "option2"]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([templateId, name])
  @@index([templateId])
  @@map("placeholders")
}

// ============================================================================
// Code Patterns (for RAG)
// ============================================================================

model CodePattern {
  id          String   @id @default(cuid())
  userId      String?
  name        String
  description String?
  language    String
  code        String   @db.Text
  embedding   Vector(1536) // OpenAI text-embedding-3-small dimension
  metadata    Json?    // Additional metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([language])
  @@map("code_patterns")
}

// ============================================================================
// Generation History
// ============================================================================

model Generation {
  id          String   @id @default(cuid())
  userId      String?
  templateId  String?
  prompt      String   @db.Text
  generatedCode String @db.Text
  language    String
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([templateId])
  @@index([createdAt])
  @@map("generations")
}

// ============================================================================
// Project Context (for multi-project support)
// ============================================================================

model Project {
  id          String   @id @default(cuid())
  userId      String
  name        String
  path        String   // Local filesystem path
  language    String?  // Primary language
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("projects")
}
